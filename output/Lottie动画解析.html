<!DOCTYPE html><!-- saved from url=(0066)http://www.kiscon.top/knowledge/lottie-web.html#%E5%89%8D%E8%A8%80 --><html lang="en-US" class=" "><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    
    <title>lottie-web 动画解析 | 前端文档</title>
    
    
    
    
    
    
  <meta name="description" content="Front end documentation"><link rel="stylesheet" href="../style.css"></head>
  <body>
    <div id="app"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="http://www.kiscon.top/" class="home-link router-link-active"><!----> <span class="site-name">前端文档</span></a> <div class="links" style="max-width: 2361px;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value="" class="" placeholder=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.kiscon.top/knowledge/com-design.html" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="http://www.kiscon.top/solution/plane.html" class="nav-link">
  解决方案
</a></div><div class="nav-item"><a href="http://www.kiscon.top/standard/base.html" class="nav-link">
  规范
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.kiscon.top/knowledge/com-design.html" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="http://www.kiscon.top/solution/plane.html" class="nav-link">
  解决方案
</a></div><div class="nav-item"><a href="http://www.kiscon.top/standard/base.html" class="nav-link">
  规范
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>知识库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items" style=""><li><a href="./组件设计.html" class="sidebar-link">组件设计</a></li><li><a href="./监控平台.html" class="sidebar-link">监控平台</a></li><li><a href="./Web安全.html" class="sidebar-link">Web安全</a></li><li><a href="./Webpack.html" class="sidebar-link">Webpack</a></li><li><a href="./Webpack原理.html" class="sidebar-link">Webpack原理</a></li><li><a href="./Webpack5+.html" class="sidebar-link">Webpack5+</a></li><li><a href="./ES7-12系列.html" class="sidebar-link">ES7-12系列</a></li><li><a href="./脚手架.html" class="sidebar-link">脚手架</a></li><li><a href="./Promise.html" class="sidebar-link">Promise</a></li><li><a href="./Git管控.html" class="sidebar-link">Git管控</a></li><li><a href="./零碎知识.html" class="sidebar-link">零碎知识</a></li><li><a href="./正则.html" class="sidebar-link">正则</a></li><li><a href="./布局方式.html" class="sidebar-link">布局方式</a></li><li><a href="./Require解读.html" class="sidebar-link">Require解读</a></li><li><a href="./BFC与IFC.html" class="sidebar-link">BFC与IFC</a></li><li><a href="./React技术栈.html" class="sidebar-link">React技术栈</a></li><li><a href="./Vue3与Vue2的区别.html" class="sidebar-link">Vue3与Vue2的区别</a></li><li><a href="./移动web.html" class="sidebar-link">移动web</a></li><li><a href="./HTTP状态码.html" class="sidebar-link">HTTP状态码</a></li><li><a href="./HTTP缓存.html" class="sidebar-link">HTTP缓存</a></li><li><a href="./事件循环与多进程.html" class="sidebar-link">事件循环与多进程</a></li><li><a href="./Rollup模块打包器.html" class="sidebar-link">Rollup模块打包器</a></li><li><a href="./小程序.html" class="sidebar-link">小程序</a></li><li><a href="./Vue3与Webpack5.html" class="sidebar-link">Vue3与Webpack5</a></li><li><a href="./Lottie动画解析.html" class="active sidebar-link" aria-current="page">Lottie动画解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E5%89%8D%E8%A8%80" class="active sidebar-link" aria-current="page">前言</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D" class="sidebar-link">使用介绍</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" class="sidebar-link">实现过程</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E7%94%9F%E6%88%90-svg" class="sidebar-link">生成 SVG</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E6%80%BB%E7%BB%93" class="sidebar-link">总结</a></li></ul></li><li><a href="./Axios核心源码解析.html" class="sidebar-link">Axios核心源码解析</a></li><li><a href="./Typescript应用.html" class="sidebar-link">Typescript应用</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>解决方案</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>规范</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lottie-web-动画解析"><a href="http://www.kiscon.top/knowledge/lottie-web.html#lottie-web-%E5%8A%A8%E7%94%BB%E8%A7%A3%E6%9E%90" class="header-anchor">#</a> lottie-web 动画解析</h1> <h2 id="前言"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E5%89%8D%E8%A8%80" class="header-anchor">#</a> 前言</h2> <p>Lottie 是一个复杂帧动画的解决方案，它提供了一套从设计师使用 AE（Adobe After Effects）到各端开发者实现动画的工具流。在设计师通过 AE 完成动画后，可以使用 AE 导出一份 JSON 格式的动画数据，然后开发同学可以通过 Lottie 将生成的 JSON 数据渲染成动画。</p> <h2 id="使用介绍"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D" class="header-anchor">#</a> 使用介绍</h2> <h3 id="_1-基本用法"><a href="http://www.kiscon.top/knowledge/lottie-web.html#_1-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95" class="header-anchor">#</a> 1. 基本用法</h3> <p>加载 Lottie 库结合 JSON 文件和下面几行代码就可以实现一个 Lottie 动画</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> lottie <span class="token keyword">from</span> <span class="token string">'lottie-web'</span>

<span class="token keyword">const</span> lot <span class="token operator">=</span> lottie<span class="token punctuation">.</span><span class="token function">loadAnimation</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>lottieBox<span class="token punctuation">,</span>
  <span class="token literal-property property">renderer</span><span class="token operator">:</span> <span class="token string">'svg'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">loop</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">autoplay</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否自动播放</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'data.json'</span> <span class="token comment">// json地址</span>
  <span class="token comment">// animationData: ''</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>注</strong>：json 动画数据，与 path 互斥，建议使用 path，因为 animationData 会将数据打包，使得 js bundle 过大</p> <h3 id="_2-常用方法"><a href="http://www.kiscon.top/knowledge/lottie-web.html#_2-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95" class="header-anchor">#</a> 2. 常用方法</h3> <p>lot.play()：播放，从当前帧开始播放</p> <p>lot.stop()：停止，并回到第 0 帧</p> <p>lot.pause()：暂停，并保持当前帧</p> <p>lot.goToAndStop(value, isFrame)：跳到某个时刻/帧并停止</p> <div class="language- extra-class"><pre class="language-text"><code>isFrame（可省略，默认false：毫秒；true：帧）指明value的单位是毫秒还是帧
</code></pre></div><p>lot.goToAndPlay(value, isFrame)：跳到某个时刻/帧并播放</p> <div class="language- extra-class"><pre class="language-text"><code>lot.goToAndStop(30, true)     // 跳转到第30帧并停止
lot.goToAndPlay(300)          // 跳转到第300毫秒并播放
</code></pre></div><p>lot.playSegments(arr, forceFlag)：以帧为单位，播放指定片段</p> <div class="language- extra-class"><pre class="language-text"><code>arr可以包含两个数字或者两个数字组成的数组，forceFlag表示是否立即强制播放该片段

lot.playSegments([10,20], false)          // 播放完之前的片段，播放10-20帧
lot.playSegments([[0,5],[10,18]], true)   // 直接播放0-5帧和10-18帧
</code></pre></div><p>lot.setSpeed(speed)：设置播放速度，speed 为 1 表示正常速度</p> <p>lot.setDirection(direction)： 设置播放方向，1 表示正向播放，-1 表示反向播放</p> <p>lot.destroy()： 删除该动画，移除相应的元素标签等。</p> <h2 id="实现过程"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B" class="header-anchor">#</a> 实现过程</h2> <p>JSON 文件数据格式在此不做解读，接下来结合 <a href="https://codepen.io/qingzhou_coder/pen/ZEpXXgw" target="_blank" rel="noopener noreferrer">Demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的 Lottie 部分源码阅读展示，了解如何把 JSON 数据动起来的。</p> <h3 id="_1-初始渲染容器"><a href="http://www.kiscon.top/knowledge/lottie-web.html#_1-%E5%88%9D%E5%A7%8B%E6%B8%B2%E6%9F%93%E5%AE%B9%E5%99%A8" class="header-anchor">#</a> 1. 初始渲染容器</h3> <p><img src="./lottie-web 动画解析 _ 前端文档_files/lot-1.png" alt="images"></p> <p><a href="https://github.com/airbnb/lottie-web/blob/master/player/js/animation/AnimationManager.js" target="_blank" rel="noopener noreferrer">AnimationManager.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setupAnimation</span><span class="token punctuation">(</span><span class="token parameter">animItem<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 监听事件</span>
  animItem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'destroy'</span><span class="token punctuation">,</span> removeElement<span class="token punctuation">)</span>
  animItem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'_active'</span><span class="token punctuation">,</span> addPlayingCount<span class="token punctuation">)</span>
  animItem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'_idle'</span><span class="token punctuation">,</span> subtractPlayingCount<span class="token punctuation">)</span>
  <span class="token comment">// 注册动画</span>
  registeredAnimations<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">elem</span><span class="token operator">:</span> element<span class="token punctuation">,</span> <span class="token literal-property property">animation</span><span class="token operator">:</span> animItem <span class="token punctuation">}</span><span class="token punctuation">)</span>
  len <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loadAnimation</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成当前动画实例，AnimationItem方法来源AnimationItem.js</span>
  <span class="token keyword">var</span> animItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnimationItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 注册动画</span>
  <span class="token function">setupAnimation</span><span class="token punctuation">(</span>animItem<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 初始化动画实例参数</span>
  animItem<span class="token punctuation">.</span><span class="token function">setParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
  <span class="token keyword">return</span> animItem
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>AnimationItem 这个类是 Lottie 动画的基类，loadAnimation 方法会先生成一个 AnimationItem 实例并返回，开发者使用的 配置参数和方法 都是来自于这个类。</p></li> <li><p>生成 animItem 实例后，调用 setupAnimation 方法。这个方法首先监听了 destroy、_active、_idle 三个事件等待被触发。由于可以多个动画并行，因此定义了全局的变量 len、registeredAnimations 等，用于判断和缓存已注册的动画实例。</p></li> <li><p>接下来调用 animItem 实例的 setParams 方法初始化动画参数，除了初始化 loop 、 autoplay 等参数外，最重要的是选择渲染器，如下：</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">AnimationItem</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setParams</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 渲染容器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>wrapper <span class="token operator">||</span> params<span class="token punctuation">.</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper <span class="token operator">=</span> params<span class="token punctuation">.</span>wrapper <span class="token operator">||</span> params<span class="token punctuation">.</span>container
  <span class="token punctuation">}</span>
  <span class="token comment">// 默认是svg格式</span>
  <span class="token keyword">var</span> animType <span class="token operator">=</span> <span class="token string">'svg'</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>animType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    animType <span class="token operator">=</span> params<span class="token punctuation">.</span>animType
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>renderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    animType <span class="token operator">=</span> params<span class="token punctuation">.</span>renderer
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据配置选择渲染器，如果不存在走html类型</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>animType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'canvas'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CanvasRenderer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>rendererSettings<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'svg'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SVGRenderer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>rendererSettings<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HybridRenderer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>rendererSettings<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>imagePreloader<span class="token punctuation">.</span><span class="token function">setCacheType</span><span class="token punctuation">(</span>animType<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>defs<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">setProjectInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>projectInterface<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>animType <span class="token operator">=</span> animType
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    params<span class="token punctuation">.</span>loop <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">||</span>
    params<span class="token punctuation">.</span>loop <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>
    params<span class="token punctuation">.</span>loop <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span>
    params<span class="token punctuation">.</span>loop <span class="token operator">===</span> <span class="token boolean">true</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loop <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>loop <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loop <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loop <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>loop<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 默认自动播放</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>autoplay <span class="token operator">=</span> <span class="token string">'autoplay'</span> <span class="token keyword">in</span> params <span class="token operator">?</span> params<span class="token punctuation">.</span>autoplay <span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token comment">// 动画名称</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> params<span class="token punctuation">.</span>name <span class="token operator">?</span> params<span class="token punctuation">.</span>name <span class="token operator">:</span> <span class="token string">''</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>autoloadSegments <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token string">'autoloadSegments'</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> params<span class="token punctuation">.</span>autoloadSegments
    <span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>assetsPath <span class="token operator">=</span> params<span class="token punctuation">.</span>assetsPath
  <span class="token keyword">this</span><span class="token punctuation">.</span>initialSegment <span class="token operator">=</span> params<span class="token punctuation">.</span>initialSegment
  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>audioFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioController<span class="token punctuation">.</span><span class="token function">setAudioFactory</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>audioFactory<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 渲染数据初始化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>animationData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupAnimation</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>animationData<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> params<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> params<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> params<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 源码在 player/js/utils/dataManager.js</span>
    <span class="token comment">// 创建一个Worker子线程去加载json数据</span>
    dataManager<span class="token punctuation">.</span><span class="token function">loadAnimation</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configAnimation<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onSetupError<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Lottie 提供了 SVG、Canvas 和 HTML 三种渲染模式，默认 SVG 模式。</p> <ul><li><p>SVG 渲染器支持的特性最多，也是使用最多的渲染方式。并且 SVG 是可伸缩的，任何分辨率下不会失真。</p></li> <li><p>Canvas 渲染器就是根据动画的数据将每一帧的对象不断重绘出来。</p></li> <li><p>HTML 渲染器受限于其功能，支持的特性最少，只能做一些很简单的图形或者文字，也不支持滤镜效果。</p></li></ul> <p>每个渲染器均有各自的实现，复杂度也各有不同，但是动画越复杂，其对性能的消耗也就越高，这些要看实际的状况再去判断。渲染器源码在 <code>player/js/renderers/</code> 文件夹下。</p> <h3 id="_2-初始化动画属性-加载静态资源"><a href="http://www.kiscon.top/knowledge/lottie-web.html#_2-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A8%E7%94%BB%E5%B1%9E%E6%80%A7-%E5%8A%A0%E8%BD%BD%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90" class="header-anchor">#</a> 2. 初始化动画属性，加载静态资源</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">AnimationItem</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">configAnimation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">animData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>animationData <span class="token operator">=</span> animData
    <span class="token comment">// 总帧数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initialSegment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>totalFrames <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initialSegment<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>initialSegment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>firstFrame <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>initialSegment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>totalFrames <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>animationData<span class="token punctuation">.</span>op <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animationData<span class="token punctuation">.</span>ip<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>firstFrame <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>animationData<span class="token punctuation">.</span>ip<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 渲染器初始化参数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">configAnimation</span><span class="token punctuation">(</span>animData<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>animData<span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      animData<span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animationData<span class="token punctuation">.</span>assets
    <span class="token comment">// 帧率</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>frameRate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animationData<span class="token punctuation">.</span>fr
    <span class="token keyword">this</span><span class="token punctuation">.</span>frameMult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animationData<span class="token punctuation">.</span>fr <span class="token operator">/</span> <span class="token number">1000</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">searchExtraCompositions</span><span class="token punctuation">(</span>animData<span class="token punctuation">.</span>assets<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>markers <span class="token operator">=</span> <span class="token function">markerParser</span><span class="token punctuation">(</span>animData<span class="token punctuation">.</span>markers <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'config_ready'</span><span class="token punctuation">)</span>
    <span class="token comment">// 加载静态资源</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">preloadImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadSegments</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updaFrameModifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 等待静态资源加载完毕</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForFontsLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 暂停声音</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>audioController<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">triggerConfigError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个方法中将会初始化更多动画对象的属性，比如总帧数 totalFrames 、帧率 frameMult 等。然后加载一些其他资源，比如图像、字体等。如下图所示：</p> <p><img src="./lottie-web 动画解析 _ 前端文档_files/lot-2.png" alt="images"></p> <p>同时在 waitForFontsLoaded 方法中等待静态资源加载完毕，加载完毕后便会调用 SVG 渲染器的 initItems 方法绘制动画图层，也就是将动画绘制出来。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">AnimationItem</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">waitForFontsLoaded</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 检查加载完毕</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>fontManager<span class="token punctuation">.</span>isLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForFontsLoaded</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">AnimationItem</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">checkLoaded</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isLoaded <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>fontManager<span class="token punctuation">.</span>isLoaded <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imagePreloader<span class="token punctuation">.</span><span class="token function">loadedImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rendererType <span class="token operator">!==</span> <span class="token string">'canvas'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>imagePreloader<span class="token punctuation">.</span><span class="token function">loadedFootages</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionsPlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      expressionsPlugin<span class="token punctuation">.</span><span class="token function">initExpressions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 初始化所有元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">initItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'DOMLoaded'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">0</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 渲染第一帧</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">gotoFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 自动播放</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoplay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 checkLoaded 方法中可以看到，通过 initItems 初始化所有元素后，便通过 gotoFrame 渲染第一帧，如果开发者配置了 autoplay 为 true，则会直接调用 play 方法播放。接下来先看 initItems 实现细节。</p> <h3 id="_3-绘制动画初始图层"><a href="http://www.kiscon.top/knowledge/lottie-web.html#_3-%E7%BB%98%E5%88%B6%E5%8A%A8%E7%94%BB%E5%88%9D%E5%A7%8B%E5%9B%BE%E5%B1%82" class="header-anchor">#</a> 3. 绘制动画初始图层</h3> <p>initItems 方法主要是调用 buildAllItems 创建所有图层。buildItem 方法又会调用 createItem 确定具体图层类型，下面看下 createItem 源码 <code>player/js/renderers/BaseRenderer.js</code> 实现：</p> <p><img src="./lottie-web 动画解析 _ 前端文档_files/lot-3.png" alt="images"></p> <p>在制作动画时，设计师操作的图层元素有很多种，比如图片、形状、文字等等。所以 layers 中每个图层会有一个字段 ty 来区分。结合 createItem 方法来看，一共有以下 9 中类型。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">BaseRenderer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">createItem</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">layer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据图层类型，创建相应的 svg 元素类的实例</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>ty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 图片</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createComp</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 合成</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSolid</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 固态</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createNull</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 空元素</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createShape</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 形状</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文字</span>
    <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createAudio</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 音频</span>
    <span class="token keyword">case</span> <span class="token number">13</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createCamera</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 摄像机</span>
    <span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFootage</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 镜头</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createNull</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>如上所知，图层类型的渲染逻辑，如 Image、Text、Audio 等等，每一种元素的渲染逻辑都实现在源码 <code>player/js/elements/</code> 文件夹下，具体实现逻辑这里就不进行展开了，感兴趣的同学自行查看。</p> <h3 id="_4-动画播放"><a href="http://www.kiscon.top/knowledge/lottie-web.html#_4-%E5%8A%A8%E7%94%BB%E6%92%AD%E6%94%BE" class="header-anchor">#</a> 4. 动画播放</h3> <p>图层绘制完毕后，就来看看动画播放。Lottie 动画播放主要是使用 AnimationItem 实例的 play 方法。如果开发者配置了 autoplay 为 true，则会在所有初始化工作准备完毕后，直接调用 play 方法播放。否则由开发者主动调用 play 方法播放。</p> <p>接下来从 play 方法了解一下整个播放流程的细节</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">AnimationItem</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">play</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">!==</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isPaused <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPaused <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>audioController<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_idle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_idle <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'_active'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>play 方法主要是触发了 _active 事件，这个 _active 事件便是初始化时注册的，该事件调用 addPlayingCount 方法，addPlayingCount 里再调用 activate 方法，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isFrozen <span class="token operator">&amp;&amp;</span> playingAnimationsNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 触发第一帧渲染</span>
      window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span>
      _stopped <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>触发后通过调用 requestAnimationFrame 方法，不断的调用 resume 方法来控制动画。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token parameter">nowTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  initTime <span class="token operator">=</span> nowTime
  <span class="token comment">// requestAnimationFrame 每次都进行计算修改 DOM</span>
  window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>resume<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>requestAnimationFrame 在正常情况下能达到 60 fps（每隔 16.7ms 左右）。通过 requestAnimationFrame 方法，每隔 16.7ms 去计算，计算的更细致而已，而且还会使得动画更流畅。来看下<code>resume</code>源码是如何处理的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token parameter">nowTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 两次 requestAnimationFrame 间隔时间</span>
  <span class="token keyword">var</span> elapsedTime <span class="token operator">=</span> nowTime <span class="token operator">-</span> initTime
  <span class="token keyword">var</span> i
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    registeredAnimations<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>animation<span class="token punctuation">.</span><span class="token function">advanceTime</span><span class="token punctuation">(</span>elapsedTime<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  initTime <span class="token operator">=</span> nowTime
  <span class="token keyword">if</span> <span class="token punctuation">(</span>playingAnimationsNum <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>_isFrozen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>resume<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    _stopped <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>首先会计算当前时间和上次时间的 diff 时间。</p></li> <li><p>之后计算动画开始到现在的时间的当前帧数。</p></li> <li><p>最后通过 renderFrame() 方法更新当前帧对应的 DOM 变化。</p></li></ul> <p>在 Lottie 中，每一次变化是根据 requestAnimationFrame 的间隔（每隔 16.7ms 左右）计算了更细致，保证动画的流畅运行。requestAnimationFrame 采用系统时间间隔，保持最佳绘制效率，让动画能够有一个统一的刷新机制，从而节省系统资源，提高系统性能，改善视觉效果。</p> <h2 id="生成-svg"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E7%94%9F%E6%88%90-svg" class="header-anchor">#</a> 生成 SVG</h2> <p><img src="./lottie-web 动画解析 _ 前端文档_files/lot-5.png" alt="images"></p> <h2 id="总结"><a href="http://www.kiscon.top/knowledge/lottie-web.html#%E6%80%BB%E7%BB%93" class="header-anchor">#</a> 总结</h2> <ol><li>Lottie 的优势</li></ol> <ul><li>动画还原度高，使动画实现更加方便，动画效果也更好。</li> <li>SVG 是可伸缩的，任何分辨率下不会失真。</li> <li>JSON 文件，可以多端复用（Web、Android、iOS、React Native）。</li> <li>JSON 文件大小会比 GIF 以及 APNG 等文件小很多，性能也会更好。</li></ul> <ol start="2"><li>Lottie 的不足</li></ol> <ul><li>Lottie-web 文件本身仍然比较大，未压缩<code>lottie.js</code>大小为 532k，轻量版压缩后<code>lottie_light.min.js</code>也有 147k。所以，需要注意 Lottie-web 的加载。</li> <li>不必要的序列帧。Lottie 的主要动画思想是绘制某一个图层不断的改变 CSS 属性，如果用了一些插件实现的动画效果，可能会造成每一帧都是一张图，那就会造成这个 JSON 文件非常大。</li> <li>部分 AE 特效不支持。有少量的 AE 动画效果，Lottie 无法实现，有些是因为性能问题，有些是没有做。</li> <li>Lottie 动画其实可以理解为 svg/canvas 动画，不能给已存在的 html 添加动画效果。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="http://www.kiscon.top/knowledge/vue3-webpack5.html" class="prev">
        Vue3与Webpack5
      </a></span> <span class="next"><a href="http://www.kiscon.top/knowledge/axios.html" class="">
        Axios核心源码解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    
  

<script>
  const sidebarLinks = document.querySelectorAll('#app > div.theme-container > aside > ul > li:nth-child(1) > section > ul > li > a.sidebar-link');
  sidebarLinks.forEach(item => {
    const href = item.href.split('/').pop();
    item.setAttribute('href', `./${item.textContent}.html`);
  });
</script></body></html>