<!DOCTYPE html><!-- saved from url=(0105)http://www.kiscon.top/knowledge/event-process.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E4%BB%8B%E7%BB%8D --><html lang="en-US" class=" "><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    
    <title>事件循环和多进程 | 前端文档</title>
    
    
    
    
    
    
  <meta name="description" content="Front end documentation"><link rel="stylesheet" href="../style.css"></head>
  <body>
    <div id="app"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="http://www.kiscon.top/" class="home-link router-link-active"><!----> <span class="site-name">前端文档</span></a> <div class="links" style="max-width: 2361px;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value="" class="" placeholder=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.kiscon.top/knowledge/com-design.html" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="http://www.kiscon.top/solution/plane.html" class="nav-link">
  解决方案
</a></div><div class="nav-item"><a href="http://www.kiscon.top/standard/base.html" class="nav-link">
  规范
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.kiscon.top/knowledge/com-design.html" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="http://www.kiscon.top/solution/plane.html" class="nav-link">
  解决方案
</a></div><div class="nav-item"><a href="http://www.kiscon.top/standard/base.html" class="nav-link">
  规范
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>知识库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items" style=""><li><a href="./组件设计.html" class="sidebar-link">组件设计</a></li><li><a href="./监控平台.html" class="sidebar-link">监控平台</a></li><li><a href="./Web安全.html" class="sidebar-link">Web安全</a></li><li><a href="./Webpack.html" class="sidebar-link">Webpack</a></li><li><a href="./Webpack原理.html" class="sidebar-link">Webpack原理</a></li><li><a href="./Webpack5+.html" class="sidebar-link">Webpack5+</a></li><li><a href="./ES7-12系列.html" class="sidebar-link">ES7-12系列</a></li><li><a href="./脚手架.html" class="sidebar-link">脚手架</a></li><li><a href="./Promise.html" class="sidebar-link">Promise</a></li><li><a href="./Git管控.html" class="sidebar-link">Git管控</a></li><li><a href="./零碎知识.html" class="sidebar-link">零碎知识</a></li><li><a href="./正则.html" class="sidebar-link">正则</a></li><li><a href="./布局方式.html" class="sidebar-link">布局方式</a></li><li><a href="./Require解读.html" class="sidebar-link">Require解读</a></li><li><a href="./BFC与IFC.html" class="sidebar-link">BFC与IFC</a></li><li><a href="./React技术栈.html" class="sidebar-link">React技术栈</a></li><li><a href="./Vue3与Vue2的区别.html" class="sidebar-link">Vue3与Vue2的区别</a></li><li><a href="./移动web.html" class="sidebar-link">移动web</a></li><li><a href="./HTTP状态码.html" class="sidebar-link">HTTP状态码</a></li><li><a href="./HTTP缓存.html" class="sidebar-link">HTTP缓存</a></li><li><a href="./事件循环与多进程.html" class="active sidebar-link" aria-current="page">事件循环与多进程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E4%BB%8B%E7%BB%8D" class="active sidebar-link" aria-current="page">事件循环介绍</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" class="sidebar-link">浏览器事件循环</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#%E5%AE%8F%E4%BB%BB%E5%8A%A1%E4%B8%8E%E5%BE%AE%E4%BB%BB%E5%8A%A1" class="sidebar-link">宏任务与微任务</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#settimeout-%E6%98%AF%E6%80%8E%E6%A0%B7%E5%B7%A5%E4%BD%9C%E7%9A%84" class="sidebar-link">setTimeout 是怎样工作的</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97" class="sidebar-link">任务队列</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#web-worker" class="sidebar-link">Web Worker</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#nodejs-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" class="sidebar-link">nodejs 事件循环</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#nodejs-%E5%A4%9A%E8%BF%9B%E7%A8%8B" class="sidebar-link">nodejs 多进程</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#cluster-%E7%9B%B8%E5%85%B3-api" class="sidebar-link">cluster 相关 API</a></li><li class="sidebar-sub-header"><a href="http://www.kiscon.top/knowledge/event-process.html#cluster-%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9E%8B" class="sidebar-link">cluster 调度模型</a></li></ul></li><li><a href="./Rollup模块打包器.html" class="sidebar-link">Rollup模块打包器</a></li><li><a href="./小程序.html" class="sidebar-link">小程序</a></li><li><a href="./Vue3与Webpack5.html" class="sidebar-link">Vue3与Webpack5</a></li><li><a href="./Lottie动画解析.html" class="sidebar-link">Lottie动画解析</a></li><li><a href="./Axios核心源码解析.html" class="sidebar-link">Axios核心源码解析</a></li><li><a href="./Typescript应用.html" class="sidebar-link">Typescript应用</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>解决方案</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>规范</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="事件循环和多进程"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%92%8C%E5%A4%9A%E8%BF%9B%E7%A8%8B" class="header-anchor">#</a> 事件循环和多进程</h1> <h2 id="事件循环介绍"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E4%BB%8B%E7%BB%8D" class="header-anchor">#</a> 事件循环介绍</h2> <h3 id="什么是事件循环"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" class="header-anchor">#</a> 什么是事件循环</h3> <p>主线程从“任务队列”中读取事件，这个过程是循环不断的，所以整个运行机制又称为 Event Loops(事件循环)。</p> <h3 id="事件循环的本质"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E7%9A%84%E6%9C%AC%E8%B4%A8" class="header-anchor">#</a> 事件循环的本质</h3> <p>本质：在浏览器或者 nodejs 环境中，运行时对 js 脚本的调度方式。</p> <h3 id="不同环境中的事件循环"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%B8%8D%E5%90%8C%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" class="header-anchor">#</a> 不同环境中的事件循环</h3> <ol><li>浏览器中的事件循环</li></ol> <p>为了协调事件(event)，用户交互(user interaction)，脚本(script)，渲染(rendering)，网路(networking)等，用户代理(user agent)必须使用事件循环(event loops)。</p> <ul><li><p>事件：postMessage，MutationObserver 等</p></li> <li><p>用户交互：click，onScroll 等</p></li> <li><p>渲染：解析 dom，css 等</p></li> <li><p>脚本：js 脚本运行</p></li></ul> <ol start="2"><li>nodejs 中事件循环</li></ol> <p>事件循环允许 Node.js 执行非阻塞 I/O 操作，尽管 JavaScript 是单线程的，通过尽可能操作卸载到系统内核。由于大多数现代内核是多线程的，因此它们可以处理在后台执行的多个操作，当其中一个操作完成时，内核会告诉 Node.js，以便可以将相应的回调添加到轮询队列中以最终执行。</p> <h2 id="浏览器事件循环"><a href="http://www.kiscon.top/knowledge/event-process.html#%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" class="header-anchor">#</a> 浏览器事件循环</h2> <h3 id="为什么-js-是单线程的"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%B8%BA%E4%BB%80%E4%B9%88-js-%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%9A%84" class="header-anchor">#</a> 为什么 js 是单线程的</h3> <p>浏览器 js 的作用是操作 DOM，这决定了它只能是单线程，否则会 DOM 操作冲突。</p> <p><strong>分析如下：</strong></p> <p>js 运行在浏览器中，是单线程的，每个 window 一个 js 线程。</p> <p>浏览器是事件驱动的（Event driven），浏览器中很多行为是 <strong>异步（Asynchronized）</strong> 的。例如：鼠标点击事件、窗口大小拖拉事件、定时器触发事件、XMLHttpRequest 完成回调等。当一个异步事件发生的时候，它就进入事件队列。浏览器有一个内部大消息循环，Event Loop（事件循环），会轮询大的事件队列并处理事件。</p> <p>事件循环有一个简单的工作——监视调用堆栈和回调队列。如果调用堆栈是空的，它将从队列中取出第一个事件，并将其推到调用堆栈，该堆栈有效地运行它。</p> <h2 id="宏任务与微任务"><a href="http://www.kiscon.top/knowledge/event-process.html#%E5%AE%8F%E4%BB%BB%E5%8A%A1%E4%B8%8E%E5%BE%AE%E4%BB%BB%E5%8A%A1" class="header-anchor">#</a> 宏任务与微任务</h2> <h3 id="为什么要分微任务和宏任务"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%86%E5%BE%AE%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%AE%8F%E4%BB%BB%E5%8A%A1" class="header-anchor">#</a> 为什么要分微任务和宏任务？</h3> <p>微任务是<strong>线程</strong>之间的切换，速度快。不用进行上下文切换，可以快速的一次性做完所有的微任务。</p> <p>宏任务是<strong>进程</strong>之间的切换，速度慢，且每次执行需要切换上下文。因此一个 Eventloop 中只执行一个宏任务。</p> <p>而区分微任务和宏任务的根本原因是为了<strong>插队</strong>。由于微任务执行快，一次性可以执行很多个，在当前宏任务执行后立刻清空微任务可以达到伪同步的效果，这对视图渲染效果起到至关重要的作用。</p> <h3 id="概念"><a href="http://www.kiscon.top/knowledge/event-process.html#%E6%A6%82%E5%BF%B5" class="header-anchor">#</a> 概念</h3> <ol><li><p>宏任务：当前调用栈中执行的代码成为宏任务。（主代码块，定时器等等）。</p></li> <li><p>微任务： 当前（此次事件循环中）宏任务执行完，在下一个宏任务开始之前需要执行的任务，可以理解为回调事件。（promise.then，proness.nextTick 等等）。</p></li> <li><p>宏任务中的事件放在 callback queue 中，由<strong>事件触发线程维护</strong>；微任务的事件放在微任务队列中，由<strong>js 引擎线程维护</strong>。</p></li></ol> <h3 id="运行机制"><a href="http://www.kiscon.top/knowledge/event-process.html#%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6" class="header-anchor">#</a> 运行机制</h3> <ol><li>宏任务进入主线程，执行过程中会收集微任务加入微任务队列。</li> <li>宏任务执行完成之后，立马执行微任务中的任务。微任务执行过程中再次收集宏任务，并加入宏任务队列中。</li> <li>当前微任务队列中的任务执行完毕，检查渲染，GUI 线程接管渲染。</li> <li>渲染完毕后，js 线程接管，开启下一次事件循环，执行下一次宏任务（事件队列中取）。</li></ol> <ul><li>宏任务(macrotask): srcipt(整体代码)，setTimeout，setInterval，setImmediate，I/O，UI rendering。</li> <li>微任务(microtask): process.nextTick，Promise，MutationObserver。</li></ul> <h3 id="高频笔试题"><a href="http://www.kiscon.top/knowledge/event-process.html#%E9%AB%98%E9%A2%91%E7%AC%94%E8%AF%95%E9%A2%98" class="header-anchor">#</a> 高频笔试题</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span>
</code></pre></div><p>每轮事件循环执行一个宏任务和所有的微任务。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span>
</code></pre></div><p>任务队列一定会保持先进先出的顺序执行。</p> <h2 id="settimeout-是怎样工作的"><a href="http://www.kiscon.top/knowledge/event-process.html#settimeout-%E6%98%AF%E6%80%8E%E6%A0%B7%E5%B7%A5%E4%BD%9C%E7%9A%84" class="header-anchor">#</a> setTimeout 是怎样工作的</h2> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cb1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Cb'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Bye'</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>Hi 添加到调用堆栈(Call Stack)中 &gt;&gt; 被执行显示在控制台 &gt;&gt; 从调用堆栈中被删除</li> <li>setTimeout 添加到调用堆栈(Call Stack)中 &gt;&gt; 被执行，Web APIs 中的浏览器创建计时器 &gt;&gt; 从调用堆栈中被删除</li> <li>Bye 添加到调用堆栈(Call Stack)中 &gt;&gt; 被执行显示在控制台 &gt;&gt; 从调用堆栈中被删除</li> <li>5s 后，计时器完成并将 cb1 回调推到回调队列 &gt;&gt; 事件循环从回调队列中获取 cb1，并将其推到调用堆栈</li> <li>cb 添加到调用堆栈(Call Stack)中 &gt;&gt; 被执行显示在控制台 &gt;&gt; 从调用堆栈中被删除</li> <li>cb1 从调用堆栈中被删除
结果：Hi Bye Cb</li></ol> <p>setTimeout(callback, 0); 作用是告诉 js 引擎，在 0ms 以后把 callback 放到主事件队列中，等待当前的代码执行完毕再执行。</p> <p><strong>注意</strong>：重点是改变了代码流程，把 callback 的执行放到了等待当前的代码执行完毕再执行。调用 setTimeout，并将 0 作为第二个参数只是推迟回调，直到调用堆栈为空。</p> <h2 id="任务队列"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97" class="header-anchor">#</a> 任务队列</h2> <ul><li><p>js 单线程：它在运行时同一时刻只能做一件事，但是浏览器给我们提供了 webapi，它们可以对应的创建一些线程，但是你不能直接访问，只能通过某种方式去调用。</p></li> <li><p>耗时的操作会阻塞调用栈，所以异步回调解决了这个问题。</p></li> <li><p>堆栈溢出：函数循环调用等。</p></li> <li><p>任务队列、回调队列：一般的 webapi 在结束后（计时结束、请求得到响应等）会把回调函数送到任务队列中。</p></li> <li><p>事件循环：就是查看栈和任务队列，如果栈空就把任务队列队头压入栈中。之后这个任务得到执行。</p></li> <li><p>setTimeout：所谓的时间并不是多久之后执行，而是最快要多久执行。</p></li> <li><p>重绘必须等到调用栈空才能进行。</p></li> <li><p>微任务的执行会因为 js 堆栈的情况有所不同。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>点击<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.btn'</span><span class="token punctuation">)</span>
  btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Microtask 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Listener 1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Microtask 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Listener 2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// btn.click()</span>

  <span class="token comment">// 通过直接点击按钮输出：Listener 1 &gt;&gt; Microtask 1 &gt;&gt; Listener 2 &gt;&gt; Microtask 2</span>
  <span class="token comment">// 通过直接调用btn.click()输出：Listener 1 &gt;&gt; Listener 2 &gt;&gt; Microtask 1 &gt;&gt; Microtask 2</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <h2 id="web-worker"><a href="http://www.kiscon.top/knowledge/event-process.html#web-worker" class="header-anchor">#</a> Web Worker</h2> <p>Web Worker 的作用，就是<strong>为 JavaScript 创造多线程环境</strong>，允许主线程创建 Worker 线程，将一些任务分配给后者运行。在主线程运行的同时，Worker 线程在后台运行，两者互不干扰。等到 Worker 线程完成计算任务，再把结果返回给主线程。这样的好处是，一些计算密集型或高延迟的任务，被 Worker 线程负担了，主线程（通常负责 UI 交互）就会很流畅，不会被阻塞或拖慢。</p> <p>Worker 线程一旦新建成功，就会始终运行，不会被主线程上的活动（比如用户点击按钮、提交表单）打断。这样有利于随时响应主线程的通信。但是，这也造成了 Worker 比较耗费资源，不应该过度使用，而且一旦使用完毕，就应该关闭。</p> <ol><li>新建<code>web-worker.html</code></li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>web-worker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>计数： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>output</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>output</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">startWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>开始工作<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">stopWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>停止工作<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">let</span> w
      <span class="token keyword">function</span> <span class="token function">startWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Worker <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:8081/web-worker.js'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          w<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> event<span class="token punctuation">.</span>data
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'抱歉，你的浏览器不支持 Web Workers...'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">stopWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 终止 web worker，并释放浏览器/计算机资源</span>
        w <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>新建<code>web-worker.js</code></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> timer

<span class="token keyword">function</span> <span class="token function">timedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token comment">// postMessage() 方法 - 它用于向 HTML 页面传回一段消息</span>
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'计算已完成'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token string">'timedCount()'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">timedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>参考资料</li></ol> <p><a href="http://www.ruanyifeng.com/blog/2018/07/web-worker.html" target="_blank" rel="noopener noreferrer">Web Worker 使用教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Worker" target="_blank" rel="noopener noreferrer">Worker API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="nodejs-事件循环"><a href="http://www.kiscon.top/knowledge/event-process.html#nodejs-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF" class="header-anchor">#</a> nodejs 事件循环</h2> <p><img src="./事件循环和多进程 _ 前端文档_files/event-1.png" alt="nodejs事件循环6阶段"></p> <h3 id="阶段概览"><a href="http://www.kiscon.top/knowledge/event-process.html#%E9%98%B6%E6%AE%B5%E6%A6%82%E8%A7%88" class="header-anchor">#</a> 阶段概览</h3> <ul><li><p><strong>timers(定时器)</strong> : 此阶段执行那些由 <code>setTimeout()</code> 和 <code>setInterval()</code> 调度的回调函数.</p></li> <li><p><strong>I/O callbacks(I/O 回调)</strong> : 此阶段会执行几乎所有的回调函数, 除了 <strong>close callbacks(关闭回调)</strong> 和 那些由 <strong>timers</strong> 与 <code>setImmediate()</code>调度的回调.</p> <blockquote><p>setImmediate 约等于 setTimeout(cb,0)</p></blockquote></li> <li><p>idle(空转), prepare : 此阶段只在内部使用</p></li> <li><p><strong>poll(轮询)</strong> : 检索新的 I/O 事件; 在恰当的时候 Node 会阻塞在这个阶段</p></li> <li><p>check(检查) : <code>setImmediate()</code> 设置的回调会在此阶段被调用</p></li> <li><p>close callbacks(关闭事件的回调): 诸如 <code>socket.on('close', ...)</code> 此类的回调在此阶段被调用</p></li></ul> <p>在事件循环的每次运行之间, Node.js 会检查它是否在等待异步 I/O 或定时器, 如果没有的话就会自动关闭.</p> <h3 id="代码执行场景"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%9C%BA%E6%99%AF" class="header-anchor">#</a> 代码执行场景</h3> <blockquote><p>在 nodejs 中，setTimeout(fn, 0) === setTimeout(fn, 1)</p> <p>在浏览器里，setTimeout(fn, 0) === setTimeout(fn, 4)</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// setImmediate有时候是1ms之前执行，有时候又是1ms之后执行</span>
</code></pre></div><p>以上代码执行顺序不确定，因为 event loop 的启动也是需要时间的，可能执行到 poll 阶段
已经超过了 1ms，此时 setTimeout 会先执行，反之 setImmediate 先执行</p> <h3 id="process-nexttick"><a href="http://www.kiscon.top/knowledge/event-process.html#process-nexttick" class="header-anchor">#</a> process.nextTick</h3> <p>process.nextTick()不在 event loop 的任何阶段执行，而是在各个阶段切换的中间执行，
即从一个阶段切换到下一个阶段执行。</p> <h3 id="eventemitter"><a href="http://www.kiscon.top/knowledge/event-process.html#eventemitter" class="header-anchor">#</a> EventEmitter</h3> <p>EventEmitter 有 2 个核心的方法，on 和 emit，node 自带订阅/发布模式</p> <h2 id="nodejs-多进程"><a href="http://www.kiscon.top/knowledge/event-process.html#nodejs-%E5%A4%9A%E8%BF%9B%E7%A8%8B" class="header-anchor">#</a> nodejs 多进程</h2> <h3 id="多进程和多线程介绍"><a href="http://www.kiscon.top/knowledge/event-process.html#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%92%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BB%8B%E7%BB%8D" class="header-anchor">#</a> 多进程和多线程介绍</h3> <blockquote><p>进程是资源分配的最小单位，线程是 CPU 调度的最小单位</p></blockquote> <p><strong>线程是进程的一个执行流</strong>，是 CPU 调度和分派的基本单位，它是比进程更小的能独立运行的基本单位。<strong>一个进程由几个线程组成</strong>，线程与同属一个进程的其它的线程共享进程所拥有的全部资源。</p> <blockquote><p>一个进程下面的线程是可以去通信的，共享资源</p></blockquote> <p><strong>进程有独立的地址空间</strong>，一个进程崩溃后，在保护模式下不会对其它进程产生影响，而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程没有单独的地址空间，一个线程死掉就等于整个进程死掉。</p> <ul><li><p>谷歌浏览器</p> <ul><li>进程： 一个 tab 就是一个进程</li> <li>线程： 一个 tab 又由多个线程组成，渲染线程，js 执行线程，垃圾回收，service worker 等等</li></ul></li></ul> <p><img src="./事件循环和多进程 _ 前端文档_files/event-2.png" alt="多进程和多线程比较"></p> <p>总结：线程快而进程可靠性高</p> <h3 id="创建多进程"><a href="http://www.kiscon.top/knowledge/event-process.html#%E5%88%9B%E5%BB%BA%E5%A4%9A%E8%BF%9B%E7%A8%8B" class="header-anchor">#</a> 创建多进程</h3> <p>利用 cluster 开启多进程</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span> <span class="token comment">// nodejs内置模块</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length

<span class="token comment">// cluster 基本原理，就是主进程fork子进程，然后管理它们。</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">主进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 正在运行</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token comment">// 衍生工作进程</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">工作进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 已退出</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  http
    <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:3000'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">工作进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 已启动</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 执行8次，八核</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="nodejs-调试方法"><a href="http://www.kiscon.top/knowledge/event-process.html#nodejs-%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95" class="header-anchor">#</a> nodejs 调试方法</h3> <p>https://code.visualstudio.com/Docs/editor/debugging</p> <p><code>vscode的 .vscode文件下面配置 launch.json</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// 使用 IntelliSense 了解相关属性。</span>
  <span class="token comment">// 悬停以查看现有属性的描述。</span>
  <span class="token comment">// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
  <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
      <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Launch Program"</span><span class="token punctuation">,</span>
      <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}/chapter4/http_cluster.js"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="cluster-相关-api"><a href="http://www.kiscon.top/knowledge/event-process.html#cluster-%E7%9B%B8%E5%85%B3-api" class="header-anchor">#</a> cluster 相关 API</h2> <p><strong>Process 进程 、child_process 子进程 、Cluster 集群</strong></p> <h3 id="process-进程"><a href="http://www.kiscon.top/knowledge/event-process.html#process-%E8%BF%9B%E7%A8%8B" class="header-anchor">#</a> process 进程</h3> <blockquote><p>process 对象是 Node 的一个全局对象，提供当前 Node 进程的信息，他可以在脚本的任意位置使用，不必通过 require 命令加载。</p></blockquote> <p><strong>属性</strong></p> <ol><li><strong>process.argv</strong> 属性，返回一个数组，包含了启动 node 进程时的命令行参数</li> <li><strong>process.env</strong> 返回包含用户环境信息的对象，可以在 脚本中对这个对象进行增删改查的操作</li> <li><strong>process.pid</strong> 返回当前进程的进程号</li> <li><strong>process.platform</strong> 返回当前的操作系统</li> <li><strong>process.version</strong> 返回当前 node 版本</li></ol> <p><strong>方法</strong></p> <ol><li><strong>process.cwd()</strong> 返回 node.js 进程当前工作目录</li> <li>process.chdir() 变更 node.js 进程的工作目录</li> <li><strong>process.nextTick(fn)</strong> 将任务放到当前事件循环的尾部，添加到 ‘next tick’ 队列，一旦当前事件轮询队列的任务全部完成，在 next tick 队列中的所有 callback 会被依次调用</li> <li><strong>process.exit()</strong> 退出当前进程，很多时候是不需要的</li> <li>process.kill(pid[,signal]) 给指定进程发送信号，包括但不限于结束进程</li></ol> <p><strong>事件</strong></p> <ol><li><p>beforeExit 事件，在 Node 清空了 EventLoop 之后，再没有任何待处理任务时触发，可以在这里再部署一些任务，使得 Node 进程不退出，显示的终止程序时（process.exit()），不会触发</p></li> <li><p>exit 事件，当前进程退出时触发，回调函数中只允许同步操作，因为执行完回调后，进程金辉退出</p></li> <li><p><strong>uncaughtException</strong> 事件，当前进程抛出一个没有捕获的错误时触发，可以用它在进程结束前进行一些已分配资源的同步清理操作，尝试用它来恢复应用的正常运行的操作是不安全的</p></li> <li><p>warning 事件，任何 Node.js 发出的进程警告，都会触发此事件</p></li></ol> <h3 id="child-process"><a href="http://www.kiscon.top/knowledge/event-process.html#child-process" class="header-anchor">#</a> child_process</h3> <blockquote><p>nodejs 中用于创建子进程的模块，node 中大名鼎鼎的 cluster 是基于它来封装的。</p></blockquote> <ol><li><strong>exec()</strong></li></ol> <p>异步衍生出一个 shell，然后在 shell 中执行命令，且缓冲任何产生的输出，运行结束后调用回调函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> exec <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exec
<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stdout: '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stdout: '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'closing code: '</span> <span class="token operator">+</span> code<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的代码还有一个好处。监听 data 事件以后，可以实时输出结果，否则只有等到子进程结束，才会输出结果。所以，如果子进程运行时间较长，或者是持续运行，第二种写法更好。</p> <ol><li><strong>execSync()</strong></li></ol> <p>exec()的同步版本</p> <ol start="3"><li><strong>execFile()</strong></li></ol> <p>execFile 方法直接执行特定的程序 shell，参数作为数组传入，不会被 bash 解释，因此具有较高的安全性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> execFile <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token function">execFile</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-c'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">exec error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stdout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stderr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol start="4"><li><strong>spawn()</strong></li></ol> <p>spawn 方法创建一个子进程来执行特定命令 shell，用法与 execFile 方法类似，但是没有回调函数，只能通过监听事件，来获取运行结果。它属于异步执行，适用于子进程长时间运行的情况。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> spawn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-c'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'UTF-8'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'closing code: '</span> <span class="token operator">+</span> code<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>spawn 返回的结果是 Buffer 需要转换为 utf8</p></blockquote> <ol start="5"><li><strong>fork()</strong></li></ol> <p>fork 方法直接创建一个子进程，执行 Node 脚本，<code>fork('./child.js')</code> 相当于 <code>spawn('node', ['./child.js'])</code> 。与 spawn 方法不同的是，fork 会在父进程与子进程之间，建立一个通信管道 pipe，用于进程之间的通信,也是 IPC 通信的基础。</p> <p><code>main.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> child_process <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> child_process<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./child.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'主线程收到消息'</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'world'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>child.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'子进程收到消息'</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="cluster"><a href="http://www.kiscon.top/knowledge/event-process.html#cluster" class="header-anchor">#</a> cluster</h3> <p>node 进行多进程的模块</p> <p><strong>属性和方法</strong></p> <ol><li><strong>isMaster</strong> 属性，返回该进程是不是主进程</li> <li><strong>isWorker</strong> 属性，返回该进程是不是工作进程</li> <li><strong>fork()</strong> 方法，只能通过主进程调用，衍生出一个新的 worker 进程，返回一个 worker 对象。和 process.child 的区别，不用创建一个新的 child.js</li> <li>setupMaster([settings]) 方法，用于修改 fork() 默认行为，一旦调用，将会按照 cluster.settings 进行设置。</li> <li>settings 属性，用于配置，参数 exec: worker 文件路径；args: 传递给 worker 的参数；execArgv: 传递给 Node.js 可执行文件的参数列表</li></ol> <p><strong>事件</strong></p> <ol><li><strong>fork</strong> 事件，当新的工作进程被 fork 时触发，可以用来记录工作进程活动</li> <li><strong>listening</strong> 事件，当一个工作进程调用 listen() 后触发，事件处理器两个参数 worker：工作进程对象</li> <li><strong>message</strong>事件， 比较特殊需要去在单独的 worker 上监听。</li> <li>online 事件，复制好一个工作进程后，工作进程主动发送一条 online 消息给主进程，主进程收到消息后触发，回调参数 worker 对象</li> <li><strong>disconnect</strong> 事件，主进程和工作进程之间 IPC 通道断开后触发</li> <li><strong>exit</strong> 事件，有工作进程退出时触发，回调参数 worker 对象、code 退出码、signal 进程被 kill 时的信号</li> <li>setup 事件，cluster.setupMaster() 执行后触发</li></ol> <p><a href="http://nodejs.cn/api/child_process.html" target="_blank" rel="noopener noreferrer"><strong>文档地址</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<a href="https://nodejs.org/api/child_process.html" target="_blank" rel="noopener noreferrer">英文版<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>cluster 多进程模型</strong></p> <p>每个 worker 进程通过使用 child_process.fork()函数，基于 IPC（Inter-Process Communication，进程间通信），实现与 master 进程间通信。</p> <h2 id="cluster-调度模型"><a href="http://www.kiscon.top/knowledge/event-process.html#cluster-%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9E%8B" class="header-anchor">#</a> cluster 调度模型</h2> <p>cluster 是由 master 监听请求，再通过 round-robin 算法分发给各个 worker，避免了惊群
现象的发生。</p> <blockquote><p>round-robin：轮询调度算法的原理是每一次把来自用户的请求轮流分配给内部中的服务器。</p></blockquote> <h3 id="cluster-优雅退出和进程守护"><a href="http://www.kiscon.top/knowledge/event-process.html#cluster-%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA%E5%92%8C%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4" class="header-anchor">#</a> cluster 优雅退出和进程守护</h3> <h4 id="优雅退出"><a href="http://www.kiscon.top/knowledge/event-process.html#%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA" class="header-anchor">#</a> 优雅退出</h4> <ol><li>关闭异常 Worker 进程所有的 TCP Server（将已有的连接快速断开，且不再接收新的连接），断开和 Master 的 IPC 通道，不再接受新的用户请求。</li> <li>Master 立刻 fork 一个新的 Worker 进程，保证在线的『工人』总数不变。</li> <li>异常 Worker 等待一段时间，处理完已经接受的请求后退出。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="进程守护"><a href="http://www.kiscon.top/knowledge/event-process.html#%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4" class="header-anchor">#</a> 进程守护</h4> <p>master 进程除了负责接收新的连接，分发给各 worker 进程处理之外，还得像天使一样默默地守护着这些 worker 进程，保障整个应用的稳定性。一旦某个 worker 进程异常退出就 fork 一个新的子进程顶替上去。</p> <div class="language-js extra-class"><pre class="language-js"><code>cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="ipc-通信"><a href="http://www.kiscon.top/knowledge/event-process.html#ipc-%E9%80%9A%E4%BF%A1" class="header-anchor">#</a> IPC 通信</h3> <p>IPC 通信就是进程间的通信。</p> <p>虽然每个 Worker 进程是相对独立的，但是它们之间始终还是需要通讯的，叫进程间通讯（IPC）。下面是 Node.js 官方提供的一段示例代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span>
<span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> worker <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  worker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hi there'</span><span class="token punctuation">)</span>
  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">msg: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> from worker#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isWorker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>细心的你可能已经发现 cluster 的 IPC 通道只存在于 Master 和 Worker 之间，Worker 与 Worker 进程互相间是没有的。那么 Worker 之间想通讯该怎么办呢？通过 Master 来转发。</p> <p>核心： worker 直接的通信，靠 master 转发，利用 workder 的 pid。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="http://www.kiscon.top/knowledge/http-cache.html" class="prev">
        HTTP缓存
      </a></span> <span class="next"><a href="http://www.kiscon.top/knowledge/rollup.html" class="">
        Rollup模块打包器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    
  

<script>
  const sidebarLinks = document.querySelectorAll('#app > div.theme-container > aside > ul > li:nth-child(1) > section > ul > li > a.sidebar-link');
  sidebarLinks.forEach(item => {
    const href = item.href.split('/').pop();
    item.setAttribute('href', `./${item.textContent}.html`);
  });
</script></body></html>